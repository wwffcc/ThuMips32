<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0058)http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="robots" content="index,nofollow">

<title>csproject2014/group2 - OS Teaching Wiki</title>
<script type="text/javascript" src="./csproject2014 group2 - OS Teaching Wiki_files/common.js"></script>

<script type="text/javascript">
<!--// common functions

// We keep here the state of the search box
searchIsDisabled = false;

function searchChange(e) {
    // Update search buttons status according to search box content.
    // Ignore empty or whitespace search term.
    var value = e.value.replace(/\s+/, '');
    if (value == '' || searchIsDisabled) { 
        searchSetDisabled(true);
    } else {
        searchSetDisabled(false);
    }
}

function searchSetDisabled(flag) {
    // Enable or disable search
    document.getElementById('fullsearch').disabled = flag;
    document.getElementById('titlesearch').disabled = flag;
}

function searchFocus(e) {
    // Update search input content on focus
    if (e.value == '搜索') {
        e.value = '';
        e.className = '';
        searchIsDisabled = false;
    }
}

function searchBlur(e) {
    // Update search input content on blur
    if (e.value == '') {
        e.value = '搜索';
        e.className = 'disabled';
        searchIsDisabled = true;
    }
}

function actionsMenuInit(title) {
    // Initialize action menu
    for (i = 0; i < document.forms.length; i++) {
        var form = document.forms[i];
        if (form.className == 'actionsmenu') {
            // Check if this form needs update
            var div = form.getElementsByTagName('div')[0];
            var label = div.getElementsByTagName('label')[0];
            if (label) {
                // This is the first time: remove label and do buton.
                div.removeChild(label);
                var dobutton = div.getElementsByTagName('input')[0];
                div.removeChild(dobutton);
                // and add menu title
                var select = div.getElementsByTagName('select')[0];
                var item = document.createElement('option');
                item.appendChild(document.createTextNode(title));
                item.value = 'show';
                select.insertBefore(item, select.options[0]);
                select.selectedIndex = 0;
            }
        }
    }
}
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="./csproject2014 group2 - OS Teaching Wiki_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="./csproject2014 group2 - OS Teaching Wiki_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="./csproject2014 group2 - OS Teaching Wiki_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="./csproject2014 group2 - OS Teaching Wiki_files/projection.css">

<!-- css only for MSIE browsers -->
<!--[if IE]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/moin_static160/modern/css/msie.css">
<![endif]-->



<link rel="Start" href="http://os.cs.tsinghua.edu.cn/oscourse/FrontPage">
<link rel="Alternate" title="维基标记" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=raw">
<link rel="Alternate" media="print" title="打印视图" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=print">
<link rel="Up" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014">
<link rel="Appendix" title="CPU部分报告.docx" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=CPU%E9%83%A8%E5%88%86%E6%8A%A5%E5%91%8A.docx">
<link rel="Appendix" title="computer_experiment.zip" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=computer_experiment.zip">
<link rel="Appendix" title="cspro2014_os.zip" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=cspro2014_os.zip">
<link rel="Appendix" title="decaf-c0.zip" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=decaf-c0.zip">
<link rel="Appendix" title="disas.py" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=disas.py">
<link rel="Appendix" title="disas_r1.py" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=disas_r1.py">
<link rel="Appendix" title="final.pdf" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=final.pdf">
<link rel="Appendix" title="lab1s0.zip" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=lab1s0.zip">
<link rel="Appendix" title="week3.pdf" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=week3.pdf">
<link rel="Appendix" title="week4.pdf" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=week4.pdf">
<link rel="Appendix" title="数据通路.pptx" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=%E6%95%B0%E6%8D%AE%E9%80%9A%E8%B7%AF.pptx">
<link rel="Appendix" title="第二周.pptx" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=%E7%AC%AC%E4%BA%8C%E5%91%A8.pptx">
<link rel="Appendix" title="编译部分报告.docx" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=%E7%BC%96%E8%AF%91%E9%83%A8%E5%88%86%E6%8A%A5%E5%91%8A.docx">
<link rel="Appendix" title="编译部分报告.pdf" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=view&target=%E7%BC%96%E8%AF%91%E9%83%A8%E5%88%86%E6%8A%A5%E5%91%8A.pdf">
<link rel="Search" href="http://os.cs.tsinghua.edu.cn/oscourse/FindPage">
<link rel="Index" href="http://os.cs.tsinghua.edu.cn/oscourse/TitleIndex">
<link rel="Glossary" href="http://os.cs.tsinghua.edu.cn/oscourse/WordIndex">
<link rel="Help" href="http://os.cs.tsinghua.edu.cn/oscourse/HelpOnFormatting">
</head>

<body lang="zh" dir="ltr">

<div id="header">
<div id="logo"><a href="http://os.cs.tsinghua.edu.cn/oscourse/FrontPage"><img src="./csproject2014 group2 - OS Teaching Wiki_files/tsinghua63x64.gif" alt="OS Teaching"></a></div>

<form id="searchform" method="get" action="">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput" style="display: none;">搜索:</label>
<input id="searchinput" type="text" name="value" value="" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search" class="disabled">
<input id="titlesearch" name="titlesearch" type="submit" value="标题" alt="Search Titles" disabled="">
<input id="fullsearch" name="fullsearch" type="submit" value="正文" alt="Search Full Text" disabled="">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<ul id="username"><li><a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/2012011392" id="userhome" title="2012011392 @ Self">2012011392</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=userprefs" id="userprefs">用户设置</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=logout&logout=logout" id="logout">登出</a></li></ul>
<div id="locationline">
<div id="interwiki"><span><a href="http://os.cs.tsinghua.edu.cn/oscourse/FrontPage">OsCourseWiki</a></span></div>

<ul id="pagelocation">
<li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014">csproject2014</a></li><li><a class="backlink" title="点击对这个标题进行全文检索" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=fullsearch&value=linkto%3A%22csproject2014/group2%22&context=180">group2</a></li>
</ul>

</div>

<ul id="pagetrail">
<li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2015/group1">csproject2015/group1</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2015">csproject2015</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2015/group2">csproject2015/group2</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014">csproject2014</a></li><li><a href="./csproject2014 group2 - OS Teaching Wiki_files/csproject2014 group2 - OS Teaching Wiki.html">csproject2014/group2</a></li>
</ul>

<ul id="navibar">
<li class="wikilink"><a href="http://os.cs.tsinghua.edu.cn/oscourse/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="http://os.cs.tsinghua.edu.cn/oscourse/FindPage">FindPage</a></li><li class="wikilink"><a href="http://os.cs.tsinghua.edu.cn/oscourse/HelpContents">HelpContents</a></li><li class="current"><a href="./csproject2014 group2 - OS Teaching Wiki_files/csproject2014 group2 - OS Teaching Wiki.html">csproject2014/group2</a></li>
</ul>

<div id="pageline"><hr style="display:none;"></div>

<ul class="editbar"><li><span class="disabled">只读网页</span></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=info">信息</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=subscribe">订阅</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=quicklink">添加链接</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile">附件</a></li><li>
<form class="actionsmenu" method="get" action="">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show">更多操作</option><option value="raw">源码</option>
<option value="print">打印视图</option>
<option value="RenderAsDocbook">输出Docbook格式</option>
<option value="refresh">删除缓存</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="SpellCheck">拼写检查</option>
<option value="LikePages">相似网页</option>
<option value="LocalSiteMap">本站地图</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="RenamePage" disabled="" class="disabled">改名</option>
<option value="DeletePage" disabled="" class="disabled">删除</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="MyPages">我的网页</option>
<option value="SubscribeUser">订阅</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="Despam">删除垃圾广告</option>
<option value="PackagePages">网页打包</option>
    </select>
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('更多操作');
//-->
</script>
</form>
</li></ul>

</div>

<div id="page" lang="zh" dir="ltr">
<div dir="ltr" id="content" lang="zh"><span class="anchor" id="top"></span>
<span class="anchor" id="line-8"></span><p class="line867"></p><div class="table-of-contents"><p class="table-of-contents-heading">目录</p><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-1f9ef860d1a2a4f3dbe749b1c6ddafa54a6f598f">2014年计算机系统综合实验课程：第二组实验进展情况</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-bc057e97a8cd221dd37bb7cc838de1b25a495117">小组成员信息</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-c3e2b2cc89def0b6e2852e9c6e4e44a290a11a62">每周展示</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-9f53e1dcc84ff1785ef2e50bfaae05bf6c60c96f">最终代码及报告</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-88cbe711abef5864b5a89596af5124de9c0ca624">重现步骤</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-c7c8b604c95d5d4cac8d3f3545d3d87b646b4a9f">准备与检测</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-a4e6913ddb411b1b874184896ec60ada342a1d21">写入 Flash</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-45b892e64d5d2602e261f90ca724d2947f685721">烧入 CPU</a></li></ol></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-923119f4ee0962f46a4e91f1585ca4af42059d9a">日志</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-5ee6c3085ef4f086db1a71734ad90c8670105c75">第二周（07-04/Fri ~ 07-10/Thu）</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-0ec425ae3fc2d3b4c2e6db3bea36836fb17dccfa">第三周（07-11/Fri ~ 07-17/Thu）</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-6b599d6be9f39c1ae2b73d997201117bfb035b8a">第四周（07-18/Fri ~ 07-24/Thu）</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-9e55bb5469eb94d319b6faabe5a71e1392b2ab6f">第五周（07-25/Fri ~ 07-30/Wed）</a></li></ol></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-b9534bd6c424dc534b6ebacdd571ef038dffba17">参考资料</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-f45ecedb6ae45f6e2c94d4b010680a25d9d379bf">测试用例与工具</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-e299e730032b877b355fc02c53e0719a42328d65">问题及解决</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-a45df63a795bf16563849996081dd8f3e6d793a0">资料整理</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-26281b678b57ddf3f8bbd90fac206c8b1fef60d9">ThinPad II 接口</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-f44e468b49ce6724f726b59faa1e13c702ae0b14">地址空间映射</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-034e0a1b1157e5be38155d2e488ae7f51f7af7c3">启动</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-796598a2d70124b32052356fca82613a209bd035">CP0 与中断支持</a></li></ol></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-067955b7534760dbb141f30a5e1f7c1d4697b359">qemu 接口</a><ol><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-30a9e130a195c4c9db80c0c5b2bb23420828b933">版本与参数</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-f44e468b49ce6724f726b59faa1e13c702ae0b14-2">地址空间映射</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-034e0a1b1157e5be38155d2e488ae7f51f7af7c3-2">启动</a></li></ol></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-39ef4fb0df564f01e8d50da8822da5e2e62095fa">中断相关</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-f4c96c44ba62e275de5f1f792a195258e3fdd9e8">ucore 未实现指令的避免</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-35b1f88d25e1f3ceca8b761e8b52ad81df7f0ae8">ucore BUGS</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2#head-516aa8280d77d25158928d1e552ac3ffd2b81379">指令检测流程</a></li></ol></li></ol></li></ol></div> <span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span><p class="line867">
</p><h1 id="head-1f9ef860d1a2a4f3dbe749b1c6ddafa54a6f598f">2014年计算机系统综合实验课程：第二组实验进展情况</h1>
<span class="anchor" id="line-11"></span><p class="line874">在这里维护2014年暑期小学期的计算机系统综合实验课程的第二组的实验进展情况。这些内容的维护是为了更好地进行实验，方便大家交流实验中遇到的问题和好的做法。 <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></p><p class="line874">进展维护要求： <span class="anchor" id="line-14"></span></p><ol type="1"><li>每周至少通报一次进展情况； <span class="anchor" id="line-15"></span></li><li>实验中用到的参考资料； <span class="anchor" id="line-16"></span></li><li>共享在实验中进行测试用例； <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></li></ol><p class="line867">
</p><h2 id="head-bc057e97a8cd221dd37bb7cc838de1b25a495117">小组成员信息</h2>
<span class="anchor" id="line-19"></span><div><table><tbody><tr>  <td><p class="line862">学号</p></td>
  <td><p class="line862">姓名</p></td>
  <td><p class="line862">邮件地址</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-20"></span><p class="line862">2011011229</p></td>
  <td><p class="line862">刘亚宁</p></td>
  <td><p class="line891"><a class="mailto" href="mailto:243662091@qq.com">243662091@qq.com</a></p></td>
</tr>
<tr>  <td><span class="anchor" id="line-21"></span><p class="line862">2011011286</p></td>
  <td><p class="line862">秦同</p></td>
  <td><p class="line891"><a class="mailto" href="mailto:peinpein@126.com">peinpein@126.com</a></p></td>
</tr>
<tr>  <td><span class="anchor" id="line-22"></span><p class="line862">2011011278</p></td>
  <td><p class="line862">武祥晋</p></td>
  <td><p class="line891"><a class="mailto" href="mailto:taccoraw@gmail.com">taccoraw@gmail.com</a></p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line867">
</p><h2 id="head-c3e2b2cc89def0b6e2852e9c6e4e44a290a11a62">每周展示</h2>
<span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><ol type="1"><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=%E6%95%B0%E6%8D%AE%E9%80%9A%E8%B7%AF.pptx" title="attachment:数据通路.pptx">数据通路.pptx</a> <span class="anchor" id="line-27"></span></p></li><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=%E7%AC%AC%E4%BA%8C%E5%91%A8.pptx" title="attachment:第二周.pptx">第二周.pptx</a> <span class="anchor" id="line-28"></span></p></li><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=week3.pdf" title="attachment:week3.pdf">week3.pdf</a> <span class="anchor" id="line-29"></span></p></li><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=week4.pdf" title="attachment:week4.pdf">week4.pdf</a> <span class="anchor" id="line-30"></span></p></li><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=final.pdf" title="attachment:final.pdf">final.pdf</a> <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></p></li></ol><p class="line867">
</p><h2 id="head-9f53e1dcc84ff1785ef2e50bfaae05bf6c60c96f">最终代码及报告</h2>
<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><ol type="1"><li><p class="line862">CPU代码：<a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=computer_experiment.zip" title="attachment:computer_experiment.zip">computer_experiment.zip</a> <span class="anchor" id="line-35"></span></p></li><li><p class="line862">CPU报告：<a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=CPU%E9%83%A8%E5%88%86%E6%8A%A5%E5%91%8A.docx" title="attachment:CPU部分报告.docx">CPU部分报告.docx</a> <span class="anchor" id="line-36"></span></p></li><li><p class="line862">OS 报告与代码：<a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=cspro2014_os.zip" title="attachment:cspro2014_os.zip">cspro2014_os.zip</a> <span class="anchor" id="line-37"></span></p></li><li><p class="line862">编译器代码：<a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=decaf-c0.zip" title="attachment:decaf-c0.zip">decaf-c0.zip</a> <span class="anchor" id="line-38"></span></p></li><li><p class="line862">编译器报告：<a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=%E7%BC%96%E8%AF%91%E9%83%A8%E5%88%86%E6%8A%A5%E5%91%8A.pdf" title="attachment:编译部分报告.pdf">编译部分报告.pdf</a> <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></p></li></ol><p class="line867">
</p><h2 id="head-88cbe711abef5864b5a89596af5124de9c0ca624">重现步骤</h2>
<span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867">
</p><h3 id="head-c7c8b604c95d5d4cac8d3f3545d3d87b646b4a9f">准备与检测</h3>
<span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><ol type="1"><li><p class="line862">解压贾开版本的 armcpu.tar.gz（<a class="https" href="https://git.net9.org/armcpu-devteam/armcpu/tree/master%EF%BC%89">https://git.net9.org/armcpu-devteam/armcpu/tree/master）</a> <span class="anchor" id="line-45"></span></p></li><li>JTAG 线连接 JTAG2 (CPLD) 和电脑 USB, 打开电源, iMPACT 中 Scan, Add Device (armcpu/archive/cpld.jed), Program. 关闭电源. <span class="anchor" id="line-46"></span></li><li>JTAG 线连接 JTAG1 (FPGA) 和电脑 USB, 打开电源, iMPACT 中 Scan, Add Device (armcpu/archive/armcpu.bit), Program. 断开 JTAG 线. <span class="anchor" id="line-47"></span></li><li>拨码开关从左至右 0x00000001. <span class="anchor" id="line-48"></span></li><li><p class="line862">在 Linux 下, USB2COM 线连接片上串口与电脑 USB. 可检查 <tt class="backtick">dmesg&nbsp;|&nbsp;less</tt> 最后几行, 以及看 /dev/ttyUSB0 是否存在. <span class="anchor" id="line-49"></span></p></li><li><p class="line862">进入 utils/memtrans, 给 run_all.sh 和 controller.py 执行权限, 执行 <tt class="backtick">sudo&nbsp;./run_all.sh</tt>. <span class="anchor" id="line-50"></span></p></li><li><p class="line862">上一条如果出错 <tt class="backtick">ValueError:&nbsp;Failed&nbsp;to&nbsp;set&nbsp;custom&nbsp;baud&nbsp;rate:&nbsp;115201</tt>, 可在 controller.py 的 70 行改为 115200. <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span></p></li></ol><p class="line867">
</p><h3 id="head-a4e6913ddb411b1b874184896ec60ada342a1d21">写入 Flash</h3>
<span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span><ol type="1"><li>完成以上准备步骤, 保证 CPLD 和 FPGA 运行贾开版本, 串口连接, controller.py 可工作. <span class="anchor" id="line-55"></span></li><li><p class="line862">清理 flash 准备写入: <tt class="backtick">sudo&nbsp;./controller.py&nbsp;flash&nbsp;erase&nbsp;0x0&nbsp;0x800000</tt> (无视最后的 <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/AssertionError">AssertionError</a>, 工具误报) <span class="anchor" id="line-56"></span></p></li><li><p class="line862">在 /tmp 内解压 mips-2014.05-27-mips-linux-gnu-i686-pc-linux-gnu.tar.bz2. (若解压至其他位置, 请在下一步 <tt class="backtick">make</tt> 前调整 Makefile 开头的 GCCPREFIX) <span class="anchor" id="line-57"></span></p></li><li><p class="line862">解压 cspro2014_os.zip, 进入 ucore/lab8, 使用 <tt class="backtick">make</tt> 完成 <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/ThinPad">ThinPad</a> II 版本的编译. (关于如何切换到 Qemu 版本, 请见双版本切换相关内容) <span class="anchor" id="line-58"></span></p></li><li><p class="line862">将 kernel 写入到 Flash: <tt class="backtick">sudo&nbsp;./controller.py&nbsp;flash&nbsp;write&nbsp;0x0&nbsp;/tmp/cspro2014_os/ucore/lab8/bin/kernel</tt> <span class="anchor" id="line-59"></span></p></li><li><p class="line862">将 sfs.img 写入到 Flash: <tt class="backtick">sudo&nbsp;./controller.py&nbsp;flash&nbsp;write&nbsp;0x300000&nbsp;/tmp/cspro2014_os/ucore/lab8/bin/sfs.img</tt> <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span></p></li></ol><p class="line867">
</p><h3 id="head-45b892e64d5d2602e261f90ca724d2947f685721">烧入 CPU</h3>
<span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><ol type="1"><li>解压 computer_experiment.zip <span class="anchor" id="line-64"></span></li><li>关闭电源. 断开 USB2COM 线, JTAG 线连接 JTAG1 (FPGA) 和电脑 USB, 打开电源, iMPACT 中 Scan, Add Device (computer_experiment/cpu.bit), Program. 断开 JTAG 线. <span class="anchor" id="line-65"></span></li><li>拨码开关从左至右 0x00010000. (即设置断点 0x0001, $pc 低 16 位不可能等于这一不对齐的地址, 因此无断点持续执行.) <span class="anchor" id="line-66"></span></li><li>在 Linux 下, USB2COM 线连接片上串口与电脑 USB. <span class="anchor" id="line-67"></span></li><li><p class="line891"><tt class="backtick">sudo&nbsp;minicom&nbsp;-s</tt> 配置: /dev/ttyUSB0, 9600-8O1, rtscts No, addlinefeed Yes, addcarreturn Yes. 并保存为默认. <span class="anchor" id="line-68"></span></p></li><li><p class="line891"><tt class="backtick">sudo&nbsp;minicom</tt>, 对 <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/ThinPad">ThinPad</a> II 用 rst 重置, 即可在 minicom 中输入输出. <tt class="backtick">Ctrl+A&nbsp;X</tt> 序列退出 minicom. <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span></p></li></ol><p class="line867">
</p><h2 id="head-923119f4ee0962f46a4e91f1585ca4af42059d9a">日志</h2>
<span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line867">
</p><h3 id="head-5ee6c3085ef4f086db1a71734ad90c8670105c75">第二周（07-04/Fri ~ 07-10/Thu）</h3>
<span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><ul><li>04/Fri：了解 qemu-system-mipsel 提供的接口，并在其中安装了 Debian。 <span class="anchor" id="line-75"></span></li><li>05/Sat：用 gdb 跟踪 qemu 中 Debian 的启动过程。 <span class="anchor" id="line-76"></span></li><li>06/Sun：调试ram，flash及串口工作。 <span class="anchor" id="line-77"></span></li><li>07/Mon：学习 MIPS Monitor mmon。CPU 开始加入 CP0。 <span class="anchor" id="line-78"></span></li><li>08/Tue：汇编与反汇编参数、初始化。 <span class="anchor" id="line-79"></span></li><li>09/Wed：终于掌握了 qemu 的启动过程，并找到了串口映射地址 0xb80003f8。可以在 qemu 中运行指令输出到串口（屏幕）。 <span class="anchor" id="line-80"></span></li><li>10/Thu：CPU主要功能编写，CP0设计与实现。 <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span></li></ul><p class="line867">
</p><h3 id="head-0ec425ae3fc2d3b4c2e6db3bea36836fb17dccfa">第三周（07-11/Fri ~ 07-17/Thu）</h3>
<span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><ul><li><p class="line862">11/Fri：ldscript &amp; kernel image。 <span class="anchor" id="line-85"></span></p></li><li>12/Sat：大致了解了老师提供的C0的完成情况，并发现测试样例的C3文件夹中没有用于比对的正确结果。 <span class="anchor" id="line-86"></span></li><li>13/Sun：调试CPU。查阅资料、跟踪 Debian 以理解 qemu 自动生成的 BIOS；尝试简单的启动与异常处理（lab1原型）。 <span class="anchor" id="line-87"></span></li><li><p class="line862">14/Mon：qemu 上简化掉串口中断的 lab1，因为 qemu 的串口接口与 <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/ThinPad">ThinPad</a> II 差别很大。 <span class="anchor" id="line-88"></span></p></li><li>15/Tue：继续实现 qemu 上 lab1。 <span class="anchor" id="line-89"></span></li><li>16/Wed：了解了编译器生成CALL代码以及分配寄存器等后端的实现过程。 <span class="anchor" id="line-90"></span></li><li>17/Thu：qemu 上 lab1 调试通过。BIOS(ROM) 实现。正在 CPU 上调试 BIOS。检查并解决 kernel 中未实现指令。（检查工具稍后上传） <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span></li></ul><p class="line867">
</p><h3 id="head-6b599d6be9f39c1ae2b73d997201117bfb035b8a">第四周（07-18/Fri ~ 07-24/Thu）</h3>
<span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><ul><li>18/Fri：CPU 的 BIOS 读取 Flash 成功。 <span class="anchor" id="line-95"></span></li><li>19/Sat：CPU完成BIOS工作测试，能够实现时钟与串口中断。编译器部分，完成了前四个参数通过a0等寄存器来传递的改动，但是在函数嵌套的情况下出现a0等寄存器冲突的问题。 <span class="anchor" id="line-96"></span></li><li>20/Sun：解决了编译器a0寄存器冲突的问题，并完成了main函数无返回值时也要在$v0中置零的修改。 <span class="anchor" id="line-97"></span></li><li>21/Mon：正在修改编译器中的指令集，以适应我们实现的操作系统。不涉及 TLB 的 lab2，即并未真正实现虚实地址映射，因此无法打印页表、通过 check_boot_pgdir。将在 lab3 中实现。 <span class="anchor" id="line-98"></span></li><li>22/Tue：修改完了编译器支持的指令集，使它能与我们实现的指令集契合。 <span class="anchor" id="line-99"></span></li><li>23/Wed：在板子上成功跑上了lab1，同时也成功运行了lab2。 <span class="anchor" id="line-100"></span></li><li>24/Thu：lab3（包括 lab2 需要 TLB 缺失读页表的部分）在 qemu 和 CPU 上运行成功。 <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span></li></ul><p class="line867">
</p><h3 id="head-9e55bb5469eb94d319b6faabe5a71e1392b2ab6f">第五周（07-25/Fri ~ 07-30/Wed）</h3>
<span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><ul><li>25/Fri：串口问题基本得到解决。lab4 在 qemu 上运行成功。 <span class="anchor" id="line-105"></span></li><li><p class="line862">26/Sat：lab5 在 qemu 上运行成功，开始与编译衔接。在 <tt class="backtick">user/libs/intrinsic.c</tt> 中实现了 <tt class="backtick">machdesc/Intrinsic.java</tt> 中定义的内置函数。（暂无 _Alloc） <span class="anchor" id="line-106"></span></p></li><li>27/Sun：lab4 与 lab5+Fibonacci.S 在板子上成功运行。lab6 (RR) 在 qemu 上运行成功，Stride 算法需要用到除法，未实现。lab6与lab7在板子上成功运行。 <span class="anchor" id="line-107"></span></li><li>28/Mon：lab8 移植，未完成。 <span class="anchor" id="line-108"></span></li><li>29/Tue：无串口中断的 lab8 在 CPU 上运行，用 Flash 当做 disk0，可以运行 ls（qemu 中 disk0 在 kernel 的 data 段）。lab8在板子上运行成功。 <span class="anchor" id="line-109"></span></li><li><p class="line891"><strong>实验完成</strong> <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span></p></li></ul><p class="line867">
</p><h2 id="head-b9534bd6c424dc534b6ebacdd571ef038dffba17">参考资料</h2>
<span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><ul><li><p class="line891"><a class="https" href="https://sourcery.mentor.com/GNUToolchain/release2791">交叉编译工具</a> <span class="anchor" id="line-114"></span></p></li><li><p class="line891"><a class="http" href="http://www.linux-mips.org/wiki/QEMU">QEMU-LinuxMIPS</a> <span class="anchor" id="line-115"></span></p></li><li><p class="line891"><a class="http" href="http://www.aurel32.net/info/debian_mips_qemu.php">qemu-system-mipsel 安装 Debian(old)</a> <span class="anchor" id="line-116"></span></p></li><li><p class="line891"><a class="http" href="http://www.stderr.nl/Blog/Software/Debian/SqueezeOnMips.html">qemu-system-mipsel 安装 Debian(new)</a> <span class="anchor" id="line-117"></span></p></li><li><p class="line891"><a class="http" href="http://www.brouhaha.com/~eric/software/mmon/">MIPS Monitor mmon</a> <span class="anchor" id="line-118"></span></p></li><li><p class="line891"><a class="http" href="http://linux.junsun.net/porting-howto/">Linux MIPS Porting Guide</a> <span class="anchor" id="line-119"></span></p></li><li><p class="line891"><a class="http" href="http://www.it.uu.se/edu/course/homepage/datsystDV/ht05/Project/tools/machinedata/malta-board.pdf">Malta User’s Manual</a> <span class="anchor" id="line-120"></span></p></li><li><p class="line891"><a class="http" href="http://www.ovpworld.org/documents/OVP_MIPS_Linux_Platform_User_Guide.pdf">OVP MIPS32 Malta Linux User Guide</a> <span class="anchor" id="line-121"></span></p></li><li><p class="line891"><a class="http" href="http://www.cs.vu.nl/~herbertb/misc/writingkernels.txt">Writing kernels that boot with Qemu and Grub</a> <span class="anchor" id="line-122"></span></p></li><li><p class="line891"><a class="http" href="http://www-inst.eecs.berkeley.edu/~cs150/fa10/Lab/CP1/Checkpoint1.pdf">Berkeley CS150 中断</a> <span class="anchor" id="line-123"></span></p></li><li><p class="line891"><a class="https" href="https://sourceware.org/binutils/docs-2.15/ld/Scripts.html#Scripts">ldscript</a> <span class="anchor" id="line-124"></span></p></li><li><p class="line891"><a class="http" href="http://retired.beyondlogic.org/serial/serial.htm">串口 UART 寄存器编程</a> <span class="anchor" id="line-125"></span></p></li><li><p class="line891"><a class="http" href="http://lxr.free-electrons.com/ident?v=2.6.32&i=do_IRQ">Linux Cross Reference</a> <span class="anchor" id="line-126"></span></p></li><li><p class="line891"><a class="http" href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">GCC Inline Assembly HOWTO</a> <span class="anchor" id="line-127"></span></p></li><li><p class="line891"><a class="http" href="http://www.hackersdelight.org/divcMore.pdf">INTEGER DIVISION BY CONSTANTS</a> <span class="anchor" id="line-128"></span></p></li><li><p class="line891"><a class="http" href="http://oreilly.com/catalog/make3/book/ch12.pdf">Debugging Makeﬁles</a> <span class="anchor" id="line-129"></span></p></li><li><p class="line891"><a class="https" href="https://www.gnu.org/software/make/manual/html_node/Quick-Reference.html">Makefile Quick Reference</a> <span class="anchor" id="line-130"></span></p></li><li><p class="line891"><a class="http" href="http://elinux.org/images/0/07/Intricacies_of_a_MIPS_Stack_Backtrace_Implementation.pdf">Intricacies of a MIPS Backtrace Implementation</a> <span class="anchor" id="line-131"></span></p></li><li><p class="line891"><a class="http" href="http://elinux.org/images/6/68/ELC2008_-_Back-tracing_in_MIPS-based_Linux_Systems.pdf">Back-tracing in MIPS-based Linux Systems</a> <span class="anchor" id="line-132"></span></p></li><li><p class="line891"><a class="http" href="http://en.wikipedia.org/wiki/Minicom">minicom (Terminal on PC)</a> <span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span></p></li></ul><p class="line867">
</p><h2 id="head-f45ecedb6ae45f6e2c94d4b010680a25d9d379bf">测试用例与工具</h2>
<span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span><p class="line874">以下测例/工具尚不完善，通用性较差，待持续更新或实验结束后整理。 <span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span></p><ul><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=disas_r1.py" title="attachment:disas_r1.py">disas_r1.py</a> 检查有无未实现指令。需要先用 <tt class="backtick">objcopy&nbsp;-j&nbsp;.text&nbsp;-O&nbsp;binary</tt> 导出代码段。建议将 stdout 重定向，观察 stderr 有无提示信息。 <span class="anchor" id="line-139"></span></p></li><li><p class="line891"><a class="attachment" href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile&do=get&target=lab1s0.zip" title="attachment:lab1s0.zip">lab1s0.zip</a> 简单的时钟与串口中断。本组时钟中断实现与 MIPS 标准不同，标准实现下应加入“读 Count 写入 Compare”。 <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span></p></li></ul><p class="line867">
</p><h2 id="head-e299e730032b877b355fc02c53e0719a42328d65">问题及解决</h2>
<span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><ul><li><p class="line891"><strong>[solved]</strong> qemu-system-mipsel(Debian 2.0.0+dfsg-2ubuntu1.1) 加载 mipsel_bios.bin(raw binary) 时会反转字节序，因此编译为小尾端则在虚拟地址空间中成为大尾端。<span class="strike">临时解决方案为按照大尾端编译。</span> 这一版本 qemu 只允许从 mipsel_bios.bin 加载 4 条指令，且在有 -kernel 参数时会被忽略。因此直接使用 -kernel 参数启动。 <span class="anchor" id="line-144"></span></p></li><li><p class="line891"><strong>[solved]</strong> 实验指导文档 J/JAL 指令功能有误，应为 PC[27:0] = immediate &lt;&lt; 2。 <span class="anchor" id="line-145"></span></p></li><li><p class="line891"><strong>[solved]</strong> 无延迟槽时，MIPS 异常 EPC 永远为当前指令，因此 syscall 之后应对 PC+4，但注意 sys_exec 中设定的 EPC 优先级更高。 <span class="anchor" id="line-146"></span></p></li><li><p class="line891"><strong>[solved]</strong> lab5 将用户态程序（ELF）以二进制形式放入 data 段，对于 MIPS 必须修改 kernel.ld 使每个文件都 4 字节对齐。 <span class="anchor" id="line-147"></span></p></li><li><p class="line891"><strong>[workaround]</strong> Flash的擦除是按块进行的，故作如下约定，当对于块首地址进行写操作时进行整块擦除，否则直接写入。 <span class="anchor" id="line-148"></span></p></li><li><p class="line891"><strong>[workaround]</strong> 内存的 SB 指令需要先读取再写入，而串口则只能读一次。为方便状态机设计，串口写一个字节使用 SW 进行，高 24 位被忽略。 <span class="anchor" id="line-149"></span></p></li><li><p class="line891"><strong>[workaround]</strong> 根据 4Kc 手册，reset 后 Status 初始状态下 BEV 和 ERL 应为 1，而 qemu 启动后 Status 为全 0。只要满足内核态、无中断，也能启动。 <span class="anchor" id="line-150"></span></p></li><li><p class="line891"><strong>[workaround]</strong> 因为未实现 TLBP 和 TLBR 指令，需要在内存中同步维护当前 TLB 内容，以便在删除页表项后更新 TLB。 <span class="anchor" id="line-151"></span></p></li><li><p class="line891"><strong>[workaround]</strong> SB 指令要先读后写，因此 SB 会先造成读缺失而不是写缺失。ucore 中对二者没有区别处理。 <span class="anchor" id="line-152"></span></p></li><li><p class="line891"><strong>[pending]</strong> MIPS 中栈帧约束较少，要输出调用栈需要进行指令分析。暂未实现列出的参考资料中的策略。 <span class="anchor" id="line-153"></span></p></li><li><p class="line891"><strong>[pending]</strong> 使用 Flash 作为 swap 存在以下理论上的问题：当物理内存不足时，需要将内存置换入 Flash；然而此时需要对 Flash 先擦除再写，就要有足够的物理内存暂存擦除区内容。当前 8M 大小的 Flash 共 23 条地址线，高 6 条为块地址，即有 64 个 128K 的块，写 Flash 导致擦除时，需要至少 124K 即 31 个物理页。一种避免擦除时内存开销的策略是，将当前块内容拷贝至预先擦好的块，然后将新页写入此块，并将旧块（原目标块）擦除。即在 Flash 中始终预留 128K 擦好的空间，而不是内存。 <span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span></p></li></ul><p class="line867">
</p><h2 id="head-a45df63a795bf16563849996081dd8f3e6d793a0">资料整理</h2>
<span class="anchor" id="line-156"></span><span class="anchor" id="line-157"></span><p class="line867">
</p><h3 id="head-26281b678b57ddf3f8bbd90fac206c8b1fef60d9">ThinPad II 接口</h3>
<span class="anchor" id="line-158"></span><span class="anchor" id="line-159"></span><p class="line867">
</p><h4 id="head-f44e468b49ce6724f726b59faa1e13c702ae0b14">地址空间映射</h4>
<span class="anchor" id="line-160"></span><div><table><tbody><tr>  <td><p class="line862">物理地址</p></td>
  <td><p class="line862">设备</p></td>
  <td><p class="line862">kseg1</p></td>
  <td><p class="line862">kseg0</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-161"></span><p class="line862">0x00000000 ~ 0x007fffff</p></td>
  <td><p class="line862">RAM</p></td>
  <td><p class="line862">0xa0000000 ~ 0xa07fffff</p></td>
  <td><p class="line862">0x80000000 ~ 0x807fffff</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-162"></span><p class="line862">0x1fc00000 ~ 0x1fc00fff</p></td>
  <td><p class="line862">ROM</p></td>
  <td><p class="line862">0xbfc00000 ~ 0xbfc00fff</p></td>
  <td><p class="line862">NA</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-163"></span><p class="line862">0x1e000000 ~ 0x1e7fffff</p></td>
  <td><p class="line862">Flash</p></td>
  <td><p class="line862">0xbe000000 ~ 0xbe7fffff</p></td>
  <td><p class="line862">NA</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-164"></span><p class="line862">0x1fd003f8, 0x1fd003fc</p></td>
  <td><p class="line862">串口1</p></td>
  <td><p class="line862">0xbfd003f8, 0xbfd003fc</p></td>
  <td><p class="line862">NA</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-165"></span><span class="anchor" id="line-166"></span><p class="line867">
</p><h4 id="head-034e0a1b1157e5be38155d2e488ae7f51f7af7c3">启动</h4>
<span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span><p class="line874">Reset 后从 0xbfc00000(ROM) 开始执行，从 Flash(0xbe000000) 中将 ELF 文件加载至虚拟内存对应位置，并跳转到 ELF 的入口地址。未参照 qemu 设置 sp/a0~a3/System controller's register。 <span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span></p><p class="line867">
</p><h4 id="head-796598a2d70124b32052356fca82613a209bd035">CP0 与中断支持</h4>
<span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span><ul><li>Int <span class="anchor" id="line-173"></span><ul><li>CP0: Count, Compare <span class="anchor" id="line-174"></span></li><li>IM/IP: 时钟: 7, 串口: 2 <span class="anchor" id="line-175"></span></li></ul></li><li>TLBMod/TLBL/TLBS/AdEL/AdES <span class="anchor" id="line-176"></span><ul><li><p class="line862">CP0: Index([3:0]Index), <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/EntryLo0">EntryLo0</a>([25:6]PFN [2:1]DV), <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/EntryLo1">EntryLo1</a>, <a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/EntryHi">EntryHi</a>([31:13]VPN2), BadVAddr <span class="anchor" id="line-177"></span></p></li></ul></li><li>Sys/RI/CpU <span class="anchor" id="line-178"></span></li><li>Other <span class="anchor" id="line-179"></span><ul><li><p class="line862">CP0: Status([15:8]IM, [4]UM, [1]EXL, [0]IE), Cause([15:8]IP, [6:2]<a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/ExcCode">ExcCode</a>), EPC <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></p></li></ul></li></ul><p class="line874">入口 0x80000180。（假设 BEV=1, IV=0, 不区分 TLB Miss/Invalid。） <span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span></p><p class="line867">
</p><h3 id="head-067955b7534760dbb141f30a5e1f7c1d4697b359">qemu 接口</h3>
<span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span><p class="line867">
</p><h4 id="head-30a9e130a195c4c9db80c0c5b2bb23420828b933">版本与参数</h4>
<span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span><p class="line862">Debian 2.0.0+dfsg-2ubuntu1.1, <tt class="backtick">qemu-system-mipsel&nbsp;-cpu&nbsp;4Kc&nbsp;-M&nbsp;malta&nbsp;-m&nbsp;8M</tt> <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span></p><p class="line867">
</p><h4 id="head-f44e468b49ce6724f726b59faa1e13c702ae0b14-2">地址空间映射</h4>
<span class="anchor" id="line-190"></span><div><table><tbody><tr>  <td><p class="line862">物理地址</p></td>
  <td><p class="line862">设备</p></td>
  <td><p class="line862">kseg1</p></td>
  <td><p class="line862">kseg0</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-191"></span><p class="line862">?</p></td>
  <td><p class="line862">RAM</p></td>
  <td><p class="line862">?</p></td>
  <td><p class="line862">?</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-192"></span><p class="line862">?</p></td>
  <td><p class="line862">Reserved</p></td>
  <td><p class="line862">?</p></td>
  <td><p class="line862">?</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-193"></span><p class="line862">?</p></td>
  <td><p class="line862">串口1</p></td>
  <td><p class="line862">?</p></td>
  <td><p class="line862">?</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><p class="line867">
</p><h4 id="head-034e0a1b1157e5be38155d2e488ae7f51f7af7c3-2">启动</h4>
<span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><p class="line874">需要传入 -kernel 参数，该参数为一 ELF 文件。qemu 启动时会自动生成起始于 0xbfc00000(ROM) 的初始化代码，最后跳转到 ELF 的入口地址。其中隐含了将 ELF 加载至虚拟内存对应位置的过程。 <span class="anchor" id="line-199"></span><span class="anchor" id="line-200"></span></p><p class="line874">qemu 自动生成的 BIOS 中，置 sp 为 0x80001fc0，传入 a0~a3 分别为 int argc, char** argv, char** envp, unsigned memsize，并在以下位置填入以下值： <span class="anchor" id="line-201"></span><span class="anchor" id="line-202"></span></p><div><table><tbody><tr>  <td><p class="line862">虚拟地址</p></td>
  <td><p class="line862">值</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-203"></span><p class="line862">0xb4000068</p></td>
  <td><p class="line862">0xdf</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-204"></span><p class="line862">0xbbe00048</p></td>
  <td><p class="line862">0xc0</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-205"></span><p class="line862">0xbbe00050</p></td>
  <td><p class="line862">0x40</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-206"></span><p class="line862">0xbbe00058</p></td>
  <td><p class="line862">0x80</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-207"></span><p class="line862">0xbbe00060</p></td>
  <td><p class="line862">0x3f</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-208"></span><p class="line862">0xbbe00080</p></td>
  <td><p class="line862">0xc1</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-209"></span><p class="line862">0xbbe00088</p></td>
  <td><p class="line862">0x5e</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span><p class="line862">根据 Malta 手册，以上物理地址（0x1be00000~0x1c000000）映射为 System controller’s internal registers。qemu 实现的 System controller 为 Core LV，<strong>完全找不到 Core LV 的资料</strong>……仅在 Debian 中发现读出了 0xbbe00048 中的 0xc0，并左移 0x15 位得到 0x18000000。（pc: 0x805f9c34，未定位到 C 源码。） <span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span></p><p class="line867">
</p><h3 id="head-39ef4fb0df564f01e8d50da8822da5e2e62095fa">中断相关</h3>
<span class="anchor" id="line-214"></span><span class="anchor" id="line-215"></span><p class="line874">如果中断关闭的过程中有中断产生，IP 位应一致保持为 1。直到中断开启后，就好像此中断刚发生一样进行异常处理。 <span class="anchor" id="line-216"></span><span class="anchor" id="line-217"></span></p><p class="line867">
</p><h3 id="head-f4c96c44ba62e275de5f1f792a195258e3fdd9e8">ucore 未实现指令的避免</h3>
<span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span><ul><li><p class="line891"><tt class="backtick">ticks&nbsp;%&nbsp;TICK_NUM&nbsp;==&nbsp;0</tt> 会产生一条 multu 指令，将 TICK_NUM 从 100 改成 128 后解决。 <span class="anchor" id="line-220"></span></p></li><li><p class="line891"><tt class="backtick">struct&nbsp;trapframe&nbsp;{}&nbsp;__attribute__((packed));</tt> 阻止了编译器的对齐，于是编译器会产生兼容非对齐访存的指令 lwl 和 lwr。只要自己在保存寄存器时注意与编译器对齐保持一致，就不用关闭对齐选项，从而让编译器认为其已对齐，产生一般的 lw 指令。 <span class="anchor" id="line-221"></span></p></li><li><p class="line891"><tt class="backtick">ROUNDUP</tt> 中将 <tt class="backtick">n</tt> 保存在局部变量 <tt class="backtick">__n</tt> 中再读出，因此产生了针对变量除法的 <tt class="backtick">divu</tt> 指令。直接使用 <tt class="backtick">n</tt> 则当其为 2 的幂时会使用位运算指令。 <span class="anchor" id="line-222"></span></p></li><li><p class="line891"><tt class="backtick">rand</tt> 函数中的 long long 乘法生成了 <tt class="backtick">mul</tt>, <tt class="backtick">mult</tt>, <tt class="backtick">multu</tt> 三种指令，暂时牺牲随机性。这一函数当前并未被用到。 <span class="anchor" id="line-223"></span></p></li><li><p class="line891"><tt class="backtick">load_icode_read</tt> 和 <tt class="backtick">sh</tt> 中的 <tt class="backtick">return&nbsp;(ret&nbsp;&lt;&nbsp;0)&nbsp;?&nbsp;ret&nbsp;:&nbsp;-1</tt> 会产生 <tt class="backtick">movn</tt> 或 <tt class="backtick">movz</tt> 等条件执行指令，改用 if/else 即可。 <span class="anchor" id="line-224"></span></p></li><li><p class="line891"><tt class="backtick">sfs_get_ops</tt> 的 <tt class="backtick">type</tt> 和 <tt class="backtick">load_icode</tt> 的 <tt class="backtick">elfhdr-&gt;e_phnum</tt> 类型为 <tt class="backtick">uint16_t</tt>，会产生 <tt class="backtick">sh</tt> 指令，用 <tt class="backtick">uint32_t</tt> 类型变量存储即可。 <span class="anchor" id="line-225"></span></p></li><li><p class="line891"><tt class="backtick">dev_tryseek</tt> 中要除以变量 <tt class="backtick">dev-&gt;d_blocksize</tt>，目前该值只可能为 4096，因此在 assert 后直接和 0xfff 逻辑与。 <span class="anchor" id="line-226"></span></p></li><li><p class="line862">用户态测例 <tt class="backtick">badsegment.c</tt> 和 <tt class="backtick">softint.c</tt> 不适用 MIPS 体系，直接删去。 <span class="anchor" id="line-227"></span></p></li><li><p class="line862">测例 <tt class="backtick">matrix.c</tt> 要除的“变量”（const）<tt class="backtick">total&nbsp;=&nbsp;21</tt> 改为 define 的 16。 <span class="anchor" id="line-228"></span></p></li><li><p class="line862">测例 <tt class="backtick">priority.c</tt> 用到变量除法，其对应的 stride 调度算法也需要除法未实现，因此移除此测例。 <span class="anchor" id="line-229"></span></p></li><li><p class="line862">测例 <tt class="backtick">math.C0</tt> 中的除法被编译为 <tt class="backtick">div</tt> 和 <tt class="backtick">mflo</tt> 的组合，在 ucore 中捕获 RI 异常后译码计算，将结果填回 lo 和 hi。 <span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span></p></li></ul><p class="line867">
</p><h3 id="head-35b1f88d25e1f3ceca8b761e8b52ad81df7f0ae8">ucore BUGS</h3>
<span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><ul><li><p class="line891"><tt class="backtick">kern/mm/pmm.c</tt> 的 <tt class="backtick">kmalloc</tt> 和 <tt class="backtick">kfree</tt> 中 <tt class="backtick">assert(n&nbsp;&gt;&nbsp;0&nbsp;&amp;&amp;&nbsp;n&nbsp;&lt;&nbsp;1024*0124)</tt>，疑似应为 <tt class="backtick">1024*1024</tt>。不影响运行。 <span class="anchor" id="line-234"></span></p></li><li><p class="line891"><tt class="backtick">kern/mm/swap.c</tt> 的 <tt class="backtick">check_swap</tt> 函数中，临时修改了 free_list 并在测试后恢复。其中恢复代码有误，会造成 7 个页的内存泄漏，但不影响运行。详细信息请见实验报告。 <span class="anchor" id="line-235"></span></p></li><li><p class="line891"><tt class="backtick">kern/mm/vmm.c</tt> 的 <tt class="backtick">check_pgfault</tt> 函数中，vma 只有写权限没有读权限。当然由于页表没有“读权限”的设计，不影响运行。（上一条中 <tt class="backtick">check_swap</tt> 同时给了 vma 读写权限。） <span class="anchor" id="line-236"></span></p></li><li><p class="line891"><tt class="backtick">user/ls.c</tt> 的 <tt class="backtick">getmode</tt> 中将常规文件标记为 <tt class="backtick">-</tt>，但 <tt class="backtick">ls</tt> 函数解析时期望常规文件为 <tt class="backtick">0</tt>，导致输出为未知类型。 <span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span></p></li></ul><p class="line867">
</p><h3 id="head-516aa8280d77d25158928d1e552ac3ffd2b81379">指令检测流程</h3>
<span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><p class="line874">下载“参考资料”中的交叉编译工具，选择 Lite 版本即可，Linux 可下 tar 版，Windows 要下载 Installer。之后会得到 gcc, objcopy, objdump 等工具，Linux 下全名形如 mips-linux-gnu-gcc，Windows 类似。disas.py 从“测试用例与工具”中下载。假设 C0 编译得到 a.S（扩展名 S 最好大写）。 <span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span></p><ul><li><p class="line891"><tt class="backtick">gcc&nbsp;-c&nbsp;a.S&nbsp;-o&nbsp;a.o</tt> 将 a.S 汇编成二进制 ELF <span class="anchor" id="line-243"></span></p></li><li><p class="line891"><tt class="backtick">objcopy&nbsp;-j&nbsp;.text&nbsp;-O&nbsp;binary&nbsp;a.o&nbsp;tmp.bin</tt> 将 a.o 的 text 段导出到 tmp.bin <span class="anchor" id="line-244"></span></p></li><li><p class="line891"><tt class="backtick">python&nbsp;disas.py&nbsp;tmp.bin&nbsp;&gt;&nbsp;tmp.txt</tt> 检查指令，如果有未知指令终端上会提示 <tt class="backtick">RI&nbsp;may&nbsp;happen!</tt>，打开 tmp.txt 搜索 <tt class="backtick">unknown</tt> 可看到未知指令的偏移、二进制编码、十六进制编码。 <span class="anchor" id="line-245"></span></p></li><li><p class="line891"><tt class="backtick">objdump&nbsp;-d&nbsp;a.o&nbsp;&gt;&nbsp;tmp.s</tt> 或 <tt class="backtick">objdump&nbsp;-D&nbsp;-b&nbsp;binary&nbsp;-mmips&nbsp;tmp.bin&nbsp;&gt;&nbsp;tmp.s</tt> 可在 tmp.s 看到标准的反汇编结果，在其中搜索未知指令的十六进制编码即可。 <span class="anchor" id="line-246"></span></p></li></ul><span class="anchor" id="bottom"></span></div><p id="pageinfo" class="info" lang="zh" dir="ltr">OsCourseWiki: csproject2014/group2  (2015-07-13 09:54:28由<span title="2010011283 @ 101.5.216.149[101.5.216.149]"><a class="nonexistent" href="http://os.cs.tsinghua.edu.cn/oscourse/2010011283" title="2010011283 @ 101.5.216.149[101.5.216.149]">2010011283</a></span>编辑)</p>

<div id="pagebottom"></div>
</div>


<div id="footer">
<ul class="editbar"><li><span class="disabled">只读网页</span></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=info">信息</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=subscribe">订阅</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=quicklink">添加链接</a></li><li><a href="http://os.cs.tsinghua.edu.cn/oscourse/csproject2014/group2?action=AttachFile">附件</a></li><li>
<form class="actionsmenu" method="get" action="">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show">更多操作</option><option value="raw">源码</option>
<option value="print">打印视图</option>
<option value="RenderAsDocbook">输出Docbook格式</option>
<option value="refresh">删除缓存</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="SpellCheck">拼写检查</option>
<option value="LikePages">相似网页</option>
<option value="LocalSiteMap">本站地图</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="RenamePage" disabled="" class="disabled">改名</option>
<option value="DeletePage" disabled="" class="disabled">删除</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="MyPages">我的网页</option>
<option value="SubscribeUser">订阅</option>
<option value="show" disabled="" class="disabled">------------</option>
<option value="Despam">删除垃圾广告</option>
<option value="PackagePages">网页打包</option>
    </select>
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('更多操作');
//-->
</script>
</form>
</li></ul>

<ul id="credits">
<li><a href="http://moinmoin.wikiwikiweb.de/">MoinMoin Powered</a></li><li><a href="http://www.python.org/">Python Powered</a></li><li><a href="http://validator.w3.org/check?uri=referer">Valid HTML 4.01</a></li>
</ul>


</div>



</body></html>